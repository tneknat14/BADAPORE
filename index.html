<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>Bacolod Damaged Electrical Posts</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<style>
body { font-family: Arial; margin: 20px; }
#map { height: 500px; margin-top: 20px; }
form { margin-bottom: 20px; }
input, textarea, button { width: 100%; margin-bottom: 10px; padding: 5px; }
img.uploaded { max-width: 200px; display: block; margin-top: 5px; }
#error { color: red; margin-bottom: 10px; }
</style>
</head>
<body>

<h2>Report Damaged Electrical Post - Bacolod</h2>

<div id="error"></div>

<form id="reportForm">
    Description:<br>
    <textarea id="description" required></textarea><br>
    Barangay:<br>
    <input type="text" id="barangay" required><br>
    Photo:<br>
    <input type="file" id="photo" accept="image/*" required><br>
    <button type="submit">Submit Report</button>
</form>

<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script>
/* --- CONFIG --- */
const AIRTABLE_PAT = "YOUR_NEW_PAT"; // Replace with new valid PAT
const AIRTABLE_BASE_ID = "appknuCqH6kGRFlxV";
const AIRTABLE_TABLE_NAME = "Badapore";
const CLOUDINARY_CLOUD_NAME = "dqhpfc5aj";
const CLOUDINARY_UPLOAD_PRESET = "public_upload";

/* --- MAP SETUP --- */
let map = L.map('map').setView([10.6769, 122.5637], 13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

let tempMarker;
map.on('click', function(e) {
    if(tempMarker) map.removeLayer(tempMarker);
    tempMarker = L.marker(e.latlng).addTo(map);
    tempMarker.bindPopup("Selected location").openPopup();
});

function showError(message) {
    document.getElementById('error').textContent = message;
}

/* --- LOAD EXISTING REPORTS --- */
async function loadReports() {
    try {
        let res = await axios.get(`https://api.airtable.com/v0/${AIRTABLE_BASE_ID}/${AIRTABLE_TABLE_NAME}`, {
            headers: { Authorization: `Bearer ${AIRTABLE_PAT}` }
        });
        res.data.records.forEach(r => {
            let f = r.fields;
            if(f.Latitude && f.Longitude && f.Photo && f.Photo[0]?.url){
                let marker = L.marker([f.Latitude, f.Longitude]).addTo(map);
                marker.bindPopup(
                    `<b>Barangay:</b> ${f.Barangay}<br>
                     <b>Description:</b> ${f.Description}<br>
                     <img src="${f.Photo[0].url}" class="uploaded">`
                );
            }
        });
    } catch(e) {
        console.error("Error loading Airtable records:", e);
        if(e.response && e.response.status === 401) showError("Unauthorized: Invalid Personal Access Token (PAT).");
        else if(e.response && e.response.status === 403) showError("Forbidden: PAT does not have access to this base.");
        else if(e.response && e.response.status === 404) showError("Not found: Check Base ID or Table Name.");
        else showError("Failed to load reports. See console for details.");
    }
}
loadReports();

/* --- FORM SUBMISSION --- */
document.getElementById('reportForm').addEventListener('submit', async function(e){
    e.preventDefault();
    showError("");

    if(!tempMarker) { showError("Please select a location on the map."); return; }

    let description = document.getElementById('description').value.trim();
    let barangay = document.getElementById('barangay').value.trim();
    let photoFile = document.getElementById('photo').files[0];

    if(!description || !barangay || !photoFile) {
        showError("All fields are required!");
        return;
    }

    try {
        // --- Upload to Cloudinary ---
        let formData = new FormData();
        formData.append("file", photoFile);
        formData.append("upload_preset", CLOUDINARY_UPLOAD_PRESET);

        let cloudRes = await axios.post(
            `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/upload`,
            formData,
            { headers: { "X-Requested-With": "XMLHttpRequest" } }
        );

        if(!cloudRes.data.secure_url) throw new Error("Cloudinary upload failed");
        let photoUrl = cloudRes.data.secure_url;
        console.log("Cloudinary URL:", photoUrl);

        // --- Submit to Airtable ---
        let airtableRes = await axios.post(
            `https://api.airtable.com/v0/${AIRTABLE_BASE_ID}/${AIRTABLE_TABLE_NAME}`,
            {
                fields: {
                    Description: description,
                    Barangay: barangay,
                    Latitude: tempMarker.getLatLng().lat,
                    Longitude: tempMarker.getLatLng().lng,
                    Photo: [{ url: photoUrl }]
                }
            },
            {
                headers: {
                    Authorization: `Bearer ${AIRTABLE_PAT}`,
                    'Content-Type': 'application/json'
                }
            }
        );

        console.log("Airtable response:", airtableRes.data);
        alert("Report submitted successfully!");
        location.reload();

    } catch(err) {
        console.error("Submission error:", err.response || err);
        if(err.response && err.response.status === 401) showError("Unauthorized: Invalid PAT.");
        else if(err.response && err.response.status === 403) showError("Forbidden: PAT does not have access to this base.");
        else if(err.response && err.response.status === 404) showError("Not found: Check Base ID or Table Name.");
        else showError("Failed to submit report. See console for details.");
    }
});
</script>
</body>
</html>
