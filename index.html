<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
<title>Bacolod Damaged Electrical Post — Mobile</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<link rel="stylesheet" href="https://api.mapbox.com/mapbox.js/plugins/leaflet-fullscreen/v1.0.1/leaflet.fullscreen.css" />

<style>
:root{
  --primary:#007bff;
  --bg:#f7fafc;
  --card:#ffffff;
  --muted:#6b7280;
}
html,body{height:100%;margin:0;background:var(--bg);font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;}
.container{max-width:900px;margin:0 auto;padding:12px;display:flex;flex-direction:column;gap:12px;}
header{display:flex;align-items:center;gap:10px}
h1{font-size:1.1rem;margin:0}
.card{background:var(--card);border-radius:12px;padding:12px;box-shadow:0 1px 3px rgba(2,6,23,0.08);}
form{display:flex;flex-direction:column;gap:10px}
label{font-size:0.9rem;color:var(--muted)}
textarea,input[type="file"],input[type="text"]{width:100%;padding:10px;border-radius:8px;border:1px solid #e5e7eb;font-size:1rem}
textarea{min-height:100px;resize:vertical}
button{background:var(--primary);color:white;border:none;padding:12px;border-radius:10px;font-size:1.05rem;cursor:pointer}
button:active{transform:translateY(1px)}
#error{margin-top:0;font-size:0.95rem}
#map{width:100%;height:56vh;border-radius:12px;overflow:hidden}
.note{font-size:0.9rem;color:var(--muted)}
.error{color:#b91c1c;font-weight:600}
#loading{text-align:center;margin-top:10px;display:none}
#loading img{width:40px;height:40px}
@media(min-width:700px){
  .container{padding:20px}
  h1{font-size:1.4rem}
  #map{height:60vh}
}
.form-first {order:0}
.map-second {order:1}
</style>
</head>
<body>
<div class="container">
  <header>
    <h1>Bacolod Damaged Electrical Post — Report</h1>
  </header>

  <section class="card form-first" aria-labelledby="form-title">
    <h2 id="form-title" style="font-size:1rem;margin:0 0 6px 0">Report</h2>
    <div id="error" class="error" role="alert" style="display:none"></div>
    <form id="reportForm" autocomplete="off">
      <label for="description">Description (what happened)</label>
      <textarea id="description" placeholder="e.g. leaning pole with hanging wires near City Hall" required></textarea>

      <label for="barangay">Barangay</label>
      <input id="barangay" type="text" placeholder="e.g. Singcang-Air" required>

      <label for="photo">Photo (take or choose)</label>
      <input id="photo" type="file" accept="image/*" capture="environment" required>

      <div class="note">Tap on the map below to choose the location</div>

      <input type="hidden" id="latitude">
      <input type="hidden" id="longitude">
      <input type="hidden" id="address">

      <button type="submit" id="submitBtn">Submit Report</button>
      <div id="loading">
        <img src="https://upload.wikimedia.org/wikipedia/commons/c/c7/Loading_2.gif" alt="Loading...">
        <div style="font-size:0.9rem;color:#6b7280;">Submitting report...</div>
      </div>
    </form>
  </section>

  <section class="card map-second" aria-label="Map">
    <div id="map" role="application" aria-label="Map showing Bacolod City"></div>
    <div style="margin-top:8px;font-size:0.95rem;color:var(--muted)">
      <strong>Selected address:</strong> <span id="selectedAddress">(tap map to select)</span>
    </div>
  </section>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://api.mapbox.com/mapbox.js/plugins/leaflet-fullscreen/v1.0.1/Leaflet.fullscreen.min.js"></script>

<script>
const AIRTABLE_PAT = "pattr4ED2Xfua6mMQ.151fae179023e5ab1ebfff03612c6f6b1507ff6b11f6113aaf3f3f047c929fb8"; // Replace with new valid PAT
const AIRTABLE_BASE_ID = "appknuCqH6kGRFlxV";
const AIRTABLE_TABLE_NAME = "Bacolod Electrical Damage Reports";
const CLOUDINARY_CLOUD_NAME = "dqhpfc5aj";
const CLOUDINARY_UPLOAD_PRESET = "public_upload";

const map = L.map('map', {
  center: [10.6769, 122.9511],
  zoom: 12,
  minZoom: 12,
  maxZoom: 18,
  fullscreenControl: true
});

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);

const redIcon = L.icon({
  iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',
  shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
  iconSize: [25, 41],
  iconAnchor: [12, 41],
  popupAnchor: [1, -34],
  shadowSize: [41, 41]
});

let currentMarker = null;
let selectedAddress = "";

async function reverseGeocode(lat, lon){
  try{
    const resp = await fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lon}`);
    if(!resp.ok) throw new Error('Geocode failed');
    const data = await resp.json();
    return data.display_name || "";
  } catch(err){ console.error("Reverse geocode error:", err); return ""; }
}

map.on('click', async function(e){
  const lat = e.latlng.lat;
  const lon = e.latlng.lng;
  document.getElementById('latitude').value = lat;
  document.getElementById('longitude').value = lon;

  if(currentMarker) map.removeLayer(currentMarker);
  currentMarker = L.marker([lat,lon], {icon:redIcon}).addTo(map);

  document.getElementById('selectedAddress').textContent = "Looking up address...";
  const addr = await reverseGeocode(lat, lon);
  selectedAddress = addr || `Lat:${lat.toFixed(6)}, Lon:${lon.toFixed(6)}`;
  document.getElementById('selectedAddress').textContent = selectedAddress;
  document.getElementById('address').value = selectedAddress;
  currentMarker.bindPopup(`<div style="max-width:220px;"><strong>${selectedAddress}</strong></div>`).openPopup();
});

async function loadReports(){
  try{
    const res = await fetch(`https://api.airtable.com/v0/${AIRTABLE_BASE_ID}/${AIRTABLE_TABLE_NAME}`, {
      headers: { Authorization: `Bearer ${AIRTABLE_PAT}` }
    });
    if(!res.ok){ console.error("Load reports failed", res.status); return; }
    const data = await res.json();
    data.records.forEach(r=>{
      const f = r.fields;
      if(f.Latitude && f.Longitude){
        const m = L.marker([f.Latitude,f.Longitude], {icon:redIcon}).addTo(map);
        let popupHtml = `<div style="max-width:250px">`;
        if(f.Description) popupHtml += `<strong>Description:</strong> ${f.Description}<br>`;
        if(f.Barangay) popupHtml += `<strong>Barangay:</strong> ${f.Barangay}<br>`;
        if(f.Address) popupHtml += `<strong>Address:</strong> ${f.Address}<br>`;
        if(f.Photo && f.Photo.length > 0) popupHtml += `<img src="${f.Photo[0].url}" style="width:100%;border-radius:6px;margin-top:5px;">`;
        popupHtml += `</div>`;
        m.bindPopup(popupHtml);
      }
    });
  }catch(err){ console.error("Error loading reports", err); }
}
loadReports();

function showError(msg){ const el=document.getElementById('error'); el.textContent=msg; el.style.display=msg?'block':'none'; }
function clearError(){ showError(''); }

async function uploadToCloudinary(file){
  const url = `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/upload`;
  const fd = new FormData();
  fd.append('file', file);
  fd.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
  const resp = await fetch(url,{method:'POST',body:fd});
  if(!resp.ok) throw new Error("Cloudinary upload failed");
  return resp.json();
}

async function isDuplicate(lat, lon, description, barangay){
  const formula = `AND(Latitude=${lat},Longitude=${lon},Description='${description.replace(/'/g,"\\'")}',Barangay='${barangay.replace(/'/g,"\\'")}')`;
  const res = await fetch(`https://api.airtable.com/v0/${AIRTABLE_BASE_ID}/${AIRTABLE_TABLE_NAME}?filterByFormula=${encodeURIComponent(formula)}`, {
    headers:{ Authorization: `Bearer ${AIRTABLE_PAT}` }
  });
  const data = await res.json();
  return data.records.length > 0;
}

document.getElementById('reportForm').addEventListener('submit', async function(ev){
  ev.preventDefault(); clearError();
  const loadingEl = document.getElementById('loading');
  loadingEl.style.display = 'block'; // show spinner

  const desc = document.getElementById('description').value.trim();
  const barangay = document.getElementById('barangay').value.trim();
  const lat = parseFloat(document.getElementById('latitude').value);
  const lon = parseFloat(document.getElementById('longitude').value);
  const photo = document.getElementById('photo').files[0];
  let addr = document.getElementById('address').value;

  if(!desc || !barangay || !photo || !lat || !lon){
    showError('Please complete all fields.');
    loadingEl.style.display='none';
    return;
  }

  if(!addr) {
    addr = `Lat:${lat.toFixed(6)}, Lon:${lon.toFixed(6)}`;
    document.getElementById('address').value = addr;
  }

  try{
    if(await isDuplicate(lat, lon, desc, barangay)){
      showError('This report already exists.');
      loadingEl.style.display='none';
      return;
    }

    const cloud = await uploadToCloudinary(photo);
    const imageUrl = cloud.secure_url;

    const record = { fields: { Description: desc, Barangay: barangay, Address: addr, Latitude: lat, Longitude: lon, Photo:[{url:imageUrl}] } };
    const airtableRes = await fetch(`https://api.airtable.com/v0/${AIRTABLE_BASE_ID}/${AIRTABLE_TABLE_NAME}`, {
      method:'POST', headers:{'Authorization':`Bearer ${AIRTABLE_PAT}`,'Content-Type':'application/json'}, body:JSON.stringify(record)
    });
    if(!airtableRes.ok){ const errText = await airtableRes.text(); console.error("Airtable error:",airtableRes.status,errText); showError('Failed to save report.'); loadingEl.style.display='none'; return; }

    let popupHtml = `<div style="max-width:250px">`;
    popupHtml += `<strong>Description:</strong> ${desc}<br>`;
    popupHtml += `<strong>Barangay:</strong> ${barangay}<br>`;
    popupHtml += `<strong>Address:</strong> ${addr}<br>`;
    popupHtml += `<img src="${imageUrl}" style="width:100%;border-radius:6px;margin-top:5px;">`;
    popupHtml += `</div>`;
    L.marker([lat,lon], {icon:redIcon}).addTo(map).bindPopup(popupHtml);

    alert('Report submitted!');
    document.getElementById('reportForm').reset();
    document.getElementById('selectedAddress').textContent='(tap map to select)';
    document.getElementById('latitude').value='';
    document.getElementById('longitude').value='';
    document.getElementById('address').value='';
    if(currentMarker){ map.removeLayer(currentMarker); currentMarker=null; }
  }catch(err){ console.error("Submit error:",err); showError('An error occurred while submitting.'); }
  loadingEl.style.display = 'none'; // hide spinner
});
</script>
</body>
</html>
